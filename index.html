<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>민채의 금융 대시보드</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif; background-color: #f3f4f6; }
    .card-details { transition: max-height .3s ease-in-out, opacity .3s ease-in-out; max-height: 0; overflow: hidden; opacity: 0; }
    .card-details.visible { max-height: 240px; opacity: 1; }
    @media (min-width: 768px) { .main-container { max-width: 100%; width: 100%; min-height: 100vh; padding: 2rem 4rem; border-radius: 0; } }
    /* 차트 영역이 반응형으로 충분한 높이를 가지도록 */
    #chart-wrap { height: 440px; }
  </style>
</head>
<body class="p-4 sm:p-8 md:p-12 lg:p-16">
  <div class="main-container max-w-full md:max-w-6xl mx-auto bg-white p-6 md:p-10 rounded-3xl shadow-xl">
    <!-- Header -->
    <header class="mb-8 md:mb-12 text-center relative">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">민채의 투자 현황</h1>
      <p class="text-gray-500">실시간 포트폴리오 현황</p>
      <button id="fullscreen-button" class="absolute top-0 right-0 mt-2 mr-2 bg-gray-200 text-gray-600 px-3 py-2 rounded-lg text-sm font-semibold hover:bg-gray-300 transition-colors">전체 화면</button>
    </header>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 md:mb-12">
      <div class="bg-indigo-600 text-white p-6 rounded-2xl shadow-lg transform transition-transform hover:scale-105">
        <p class="text-sm font-semibold/none opacity-80">총 포트폴리오 평가액</p>
        <p id="total-value" class="text-3xl font-extrabold mt-2">₩0</p>
      </div>
      <div class="bg-gray-800 text-white p-6 rounded-2xl shadow-lg transform transition-transform hover:scale-105">
        <p class="text-sm font-semibold/none opacity-80">총 손익</p>
        <p id="total-profit-loss" class="text-3xl font-extrabold mt-2">₩0</p>
      </div>
    </div>

    <!-- Holdings -->
    <section>
      <h2 class="text-2xl font-semibold text-gray-800 mb-4">보유 자산</h2>
      <div id="holdings-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
    </section>

    <!-- Chart -->
    <section class="mt-8 md:mt-12">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">자산별 투자 성과</h2>
      <div id="chart-wrap" class="bg-white p-6 rounded-2xl shadow-lg">
        <canvas id="investment-chart"></canvas>
      </div>
    </section>

    <!-- Cash -->
    <div class="bg-blue-100 p-6 rounded-2xl shadow-inner mt-6">
      <h3 class="text-xl font-bold text-gray-700">현금 자산</h3>
      <p id="cash-value" class="text-3xl font-extrabold mt-2 text-blue-700">₩0</p>
    </div>

    <!-- Status -->
    <div id="status-message" class="text-center mt-8 text-gray-500">데이터를 불러오는 중입니다...</div>
  </div>

  <script>
    // ====== CONFIG ======
    // Google Sheets: 파일 > 웹에 게시 > 링크 복사(쉼표로 구분된 값)
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQnDFQqH68Ig8YVehCQj7yfKGIea3OX3L2RlQ8cDGITWE-gKZ0ksp_w5phw0SjD34xS7nLC2mqa0_3T/pub?gid=1919078711&single=true&output=csv";
    // 새 데이터 폴링 주기(ms)
    const REFRESH_MS = 5 * 60 * 1000; // 5분

    // ====== DATA ======
    const investments = [
      { name: '글로벌 우주기술 & 방산 (주식)', fund_cd: 'K55101E11251', quantity: 5_732_516, purchasePrice: 1855, currentPrice: 0 },
      { name: '로보테크(주식)', fund_cd: 'K55207BV6083', quantity: 5_788_866, purchasePrice: 1727, currentPrice: 0 },
      { name: '전략 배분 TDF(주식)', fund_cd: 'K55301BM7905', quantity: 8_482_880, purchasePrice: 1179, currentPrice: 0 }
    ];
    // 보유 현금(원)
    const cash = 503_107;

    // ====== HELPERS ======
    const statusEl = document.getElementById('status-message');

    // ₩ 백만(MM) 단위 표기
    function formatToMM(num) {
      if (!isFinite(num)) return '₩0.00 MM';
      const mm = num / 1_000_000; // 1,000,000원 = 1.00 MM
      return `₩${mm.toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MM`;
    }
    function formatWon(num) { return `₩${Number(num || 0).toLocaleString('ko-KR')}`; }

    // 안전한 CSV split (따옴표 내부 콤마 무시)
    const SAFE_CSV_SPLIT = /,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/;

    // ====== FETCH & PARSE ======
    async function fetchSheet() {
      showStatus('데이터를 불러오는 중입니다...', false);
      try {
        const res = await fetch(CSV_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error(`네트워크 오류: ${res.status} ${res.statusText}`);
        const text = await res.text();
        const rows = text.trim().split(/\r?\n/);
        if (rows.length <= 1) throw new Error('스프레드시트에 데이터가 없거나 형식이 올바르지 않습니다.');

        // 최근 행들 중에서 각 펀드코드별 최신가 선택
        const lookback = 15; // 최근 15행까지 검사(안전)
        const recent = rows.slice(-Math.min(lookback, rows.length - 1));

        // 헤더 추정: 첫 행
        const header = rows[0].split(SAFE_CSV_SPLIT).map(s => s.replaceAll('"', '').trim());
        // 기준가 열 인덱스(헤더에 Base, 기준가 등 포함 단어 탐색)
        const priceIdx = header.findIndex(h => /base|기준가|price/i.test(h));
        const codeIdx  = header.findIndex(h => /fund.?code|코드|code/i.test(h));
        // 헤더가 없거나 찾지 못하면 기본 인덱스(코드=0, 가격=4)에 폴백
        const pIdx = priceIdx >= 0 ? priceIdx : 4;
        const cIdx = codeIdx  >= 0 ? codeIdx  : 0;

        // 업데이트
        for (const inv of investments) {
          const row = [...recent].reverse().find(r => r.includes(inv.fund_cd));
          if (row) {
            const cols = row.split(SAFE_CSV_SPLIT).map(s => s.replaceAll('"', '').trim());
            const raw = cols[pIdx];
            const val = Number(raw?.replace(/[^0-9.\-]/g, ''));
            if (isFinite(val)) {
              inv.currentPrice = val;
            }
          }
        }

        renderAll();
        hideStatus();
      } catch (err) {
        showStatus(`오류: ${err.message} — CSV URL과 공개 설정을 확인하세요.`, true);
        console.error(err);
      }
    }

    function showStatus(msg, isError) {
      statusEl.textContent = msg;
      statusEl.style.color = isError ? '#dc2626' : '#6b7280';
      statusEl.style.display = 'block';
    }
    function hideStatus() { statusEl.style.display = 'none'; }

    // ====== RENDER ======
    function renderHoldings() {
      const container = document.getElementById('holdings-container');
      container.innerHTML = '';

      let totalValue = cash;
      let totalPL = 0;

      for (const inv of investments) {
        const qty = inv.quantity / 1000; // 1000배 표기 오류 보정
        const currentValue = (inv.currentPrice || 0) * qty;
        const profitLoss = ((inv.currentPrice || 0) - inv.purchasePrice) * qty;
        totalValue += currentValue;
        totalPL += profitLoss;

        const isGain = profitLoss >= 0;
        const card = document.createElement('div');
        card.className = 'bg-gray-100 p-6 rounded-xl shadow-inner cursor-pointer transition-all duration-300 transform hover:scale-105';
        card.innerHTML = `
          <h3 class="text-xl font-bold text-gray-700">${inv.name}</h3>
          <div class="mt-4 grid grid-cols-2 gap-4 text-sm font-medium">
            <div>
              <p class="text-gray-500">현재 평가액</p>
              <p class="font-bold text-gray-800">${formatToMM(currentValue)}</p>
            </div>
            <div>
              <p class="text-gray-500">현재 손익</p>
              <p class="font-bold ${isGain ? 'text-green-600' : 'text-red-600'}">${isGain ? '+' : ''}${formatToMM(Math.abs(profitLoss))}</p>
            </div>
          </div>
          <div class="card-details mt-4 text-sm font-medium">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <p class="text-gray-500">수량</p>
                <p class="font-bold text-gray-800">${qty.toLocaleString('ko-KR')}</p>
              </div>
              <div>
                <p class="text-gray-500">평단가</p>
                <p class="font-bold text-gray-800">${formatWon(inv.purchasePrice)}</p>
              </div>
              <div>
                <p class="text-gray-500">현재 기준가</p>
                <p class="font-bold text-gray-800">${inv.currentPrice ? formatWon(inv.currentPrice) : '—'}</p>
              </div>
              <div>
                <p class="text-gray-500">펀드 코드</p>
                <p class="font-bold text-gray-800">${inv.fund_cd}</p>
              </div>
            </div>
          </div>
        `;
        // 토글 디테일
        card.addEventListener('click', () => card.querySelector('.card-details').classList.toggle('visible'));
        container.appendChild(card);
      }

      // KPI 업데이트
      document.getElementById('total-value').textContent = formatToMM(totalValue);
      const totalPLEl = document.getElementById('total-profit-loss');
      totalPLEl.textContent = `${totalPL >= 0 ? '+' : ''}${formatToMM(Math.abs(totalPL))}`;
      totalPLEl.parentElement.style.backgroundColor = totalPL >= 0 ? '#10B981' : '#EF4444';
      document.getElementById('cash-value').textContent = formatToMM(cash);
    }

    let chart;
    function renderChart() {
      const labels = investments.map(i => i.name);
      const qtys = investments.map(i => i.quantity / 1000);
      const initialValues = investments.map((i, idx) => Math.round(qtys[idx] * i.purchasePrice));
      const currentValues = investments.map((i, idx) => Math.round(qtys[idx] * (i.currentPrice || 0)));

      const ctx = document.getElementById('investment-chart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: '초기 투자금', data: initialValues, backgroundColor: 'rgba(59,130,246,0.8)', borderColor: 'rgba(59,130,246,1)', borderWidth: 1 },
            { label: '현재 가치', data: currentValues, backgroundColor: 'rgba(16,185,129,0.8)', borderColor: 'rgba(16,185,129,1)', borderWidth: 1 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: '₩ (백만, MM)' },
              ticks: { callback: (v) => formatToMM(v) }
            }
          },
          plugins: {
            legend: { position: 'top' },
            tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${formatToMM(ctx.parsed.y)}` } }
          }
        }
      });
    }

    function renderAll() { renderHoldings(); renderChart(); }

    // ====== FULLSCREEN ======
    function enterFullscreen() {
      try {
        const el = document.documentElement;
        if (el.requestFullscreen) el.requestFullscreen();
        else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
        else if (el.msRequestFullscreen) el.msRequestFullscreen();
      } catch (e) {
        showStatus('전체 화면 기능은 이 환경에서 지원되지 않습니다. 웹 서버(예: GitHub Pages)에서 열어 주세요.', true);
        console.error(e);
      }
    }

    // ====== INIT ======
    window.addEventListener('load', () => {
      document.getElementById('fullscreen-button').addEventListener('click', enterFullscreen);
      fetchSheet(); // 최초 로드
      // 주기적 새로고침
      setInterval(fetchSheet, REFRESH_MS);
    });
  </script>
</body>
</html>
