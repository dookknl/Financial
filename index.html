<!DOCTYPE html>
<html lang="ko" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë¯¼ì±„ì˜ ê¸ˆìœµ ëŒ€ì‹œë³´ë“œ</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: {
            soft: '0 10px 30px rgba(0,0,0,0.06)'
          }
        }
      },
      darkMode: 'class'
    }
  </script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif; }
    .card-details { transition: max-height .3s ease, opacity .3s ease; max-height: 0; overflow: hidden; opacity: 0; }
    .card-details.visible { max-height: 260px; opacity: 1; }
    .skeleton { background: linear-gradient(90deg, rgba(0,0,0,0.06), rgba(0,0,0,0.12), rgba(0,0,0,0.06)); background-size: 200% 100%; animation: shimmer 1.2s infinite; }
    @keyframes shimmer { from { background-position: 200% 0;} to { background-position: -200% 0;} }
    @media (min-width: 1024px) { .main-container { min-height: 100vh; } }
  </style>
</head>
<body class="h-full bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100">
  <div class="main-container mx-auto max-w-7xl p-4 sm:p-6 lg:p-10">
    <!-- Top Bar -->
    <div class="flex items-center gap-3 mb-6">
      <div class="flex items-center gap-3">
        <div class="w-11 h-11 rounded-2xl bg-indigo-600 text-white grid place-items-center shadow-soft">M</div>
        <div>
          <h1 class="text-2xl sm:text-3xl font-extrabold">ë¯¼ì±„ì˜ íˆ¬ì ëŒ€ì‹œë³´ë“œ</h1>
          <p id="last-updated" class="text-xs text-slate-500 dark:text-slate-400">ìµœê·¼ ì—…ë°ì´íŠ¸: â€”</p>
        </div>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <button id="refreshBtn" class="px-3 py-2 rounded-xl text-sm bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/70 shadow-soft">ìƒˆë¡œê³ ì¹¨</button>
        <button id="toggleTheme" class="px-3 py-2 rounded-xl text-sm bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/70 shadow-soft" title="ë¼ì´íŠ¸/ë‹¤í¬ ì „í™˜">ğŸŒ—</button>
        <button id="fullscreen-button" class="px-3 py-2 rounded-xl text-sm bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/70 shadow-soft" title="ì „ì²´ í™”ë©´">â›¶</button>
      </div>
    </div>

    <!-- Status / Alerts -->
    <div id="status-banner" class="hidden mb-4 rounded-2xl border border-amber-200 bg-amber-50 text-amber-800 dark:border-amber-900/40 dark:bg-amber-950/40 dark:text-amber-200 px-4 py-3 text-sm">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦</div>

    <!-- KPI Cards -->
    <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-6">
      <div class="kpi bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-soft border border-slate-100 dark:border-slate-800">
        <div class="text-sm text-slate-500 dark:text-slate-400">ì´ í‰ê°€ì•¡</div>
        <div id="kpi-total" class="text-3xl font-extrabold mt-1 tracking-tight">â‚©0</div>
        <div id="kpi-total-mm" class="text-xs text-slate-500 mt-1">â‚©0.00 MM</div>
      </div>
      <div class="kpi bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-soft border border-slate-100 dark:border-slate-800">
        <div class="text-sm text-slate-500 dark:text-slate-400">ì´ ì†ìµ</div>
        <div id="kpi-pl" class="text-3xl font-extrabold mt-1 tracking-tight">â‚©0</div>
        <div id="kpi-pl-rate" class="text-xs mt-1">â€”</div>
      </div>
      <div class="kpi bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-soft border border-slate-100 dark:border-slate-800">
        <div class="text-sm text-slate-500 dark:text-slate-400">í˜„ê¸ˆ</div>
        <div id="kpi-cash" class="text-3xl font-extrabold mt-1 tracking-tight">â‚©0</div>
        <div class="text-xs text-slate-500 mt-1">ì•ˆì „ ìì‚°</div>
      </div>
      <div class="kpi bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-soft border border-slate-100 dark:border-slate-800">
        <div class="text-sm text-slate-500 dark:text-slate-400">ë³´ìœ  ìì‚° ìˆ˜</div>
        <div id="kpi-count" class="text-3xl font-extrabold mt-1 tracking-tight">0</div>
        <div class="text-xs text-slate-500 mt-1">í€ë“œ + í˜„ê¸ˆ</div>
      </div>
    </section>

    <!-- Charts Row -->
    <section class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-8">
      <!-- Allocation Donut -->
      <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-soft border border-slate-100 dark:border-slate-800">
        <h2 class="text-lg font-bold mb-4">ìì‚° ë°°ë¶„</h2>
        <div class="h-[320px]"><canvas id="donut"></canvas></div>
      </div>
      <!-- P/L by Asset -->
      <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-soft border border-slate-100 dark:border-slate-800">
        <h2 class="text-lg font-bold mb-4">ìì‚°ë³„ ì†ìµ</h2>
        <div class="h-[320px]"><canvas id="bars"></canvas></div>
      </div>
      <!-- Portfolio Over Time (if ë‚ ì§œ ì—´ ì¡´ì¬) -->
      <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-soft border border-slate-100 dark:border-slate-800">
        <div class="flex items-center gap-2 mb-4">
          <h2 class="text-lg font-bold">í¬íŠ¸í´ë¦¬ì˜¤ ì¶”ì´</h2>
          <span id="timeline-badge" class="ml-2 text-[10px] px-2 py-0.5 rounded-full border border-slate-200 dark:border-slate-700 text-slate-500">ë‚ ì§œ ë°ì´í„° íƒì§€ ì•ˆ ë¨</span>
        </div>
        <div class="h-[320px]"><canvas id="line"></canvas></div>
      </div>
    </section>

    <!-- Holdings -->
    <section class="mb-10">
      <div class="flex items-end justify-between mb-3">
        <h2 class="text-xl font-extrabold">ë³´ìœ  ìì‚°</h2>
        <div class="text-xs text-slate-500">ì¹´ë“œë¥¼ íƒ­í•˜ë©´ ìƒì„¸ê°€ í¼ì³ì§‘ë‹ˆë‹¤</div>
      </div>
      <div id="holdings" class="grid grid-cols-1 md:grid-cols-2 gap-5"></div>
    </section>

    <!-- Footer -->
    <footer class="text-center text-xs text-slate-500 pb-8 opacity-80">Â© for Minchae Â· GitHub Pages & Google Sheets ì—°ë™</footer>
  </div>

  <script>
    // ===================== CONFIG =====================
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQnDFQqH68Ig8YVehCQj7yfKGIea3OX3L2RlQ8cDGITWE-gKZ0ksp_w5phw0SjD34xS7nLC2mqa0_3T/pub?gid=1919078711&single=true&output=csv"; // ê³µê°œ CSV
    const REFRESH_MS = 5 * 60 * 1000; // 5ë¶„

    // íˆ¬ì ìì‚° ì •ì˜ (ìˆ˜ëŸ‰ì€ 1/1000 ë³´ì • í¬í•¨í•˜ì—¬ ì‹¤ì œ ë‹¨ìœ„ë¡œ ë„£ì–´ë„ ë¨)
    const investments = [
      { name: 'ê¸€ë¡œë²Œ ìš°ì£¼ê¸°ìˆ  & ë°©ì‚° (ì£¼ì‹)', fund_cd: 'K55101E11251', quantity: 5_732_516, purchasePrice: 1855, currentPrice: 0 },
      { name: 'ë¡œë³´í…Œí¬(ì£¼ì‹)', fund_cd: 'K55207BV6083', quantity: 5_788_866, purchasePrice: 1727, currentPrice: 0 },
      { name: 'ì „ëµ ë°°ë¶„ TDF(ì£¼ì‹)', fund_cd: 'K55301BM7905', quantity: 8_482_880, purchasePrice: 1179, currentPrice: 0 }
    ];
    const cash = 503_107; // ì›í™” í˜„ê¸ˆ

    // ===================== HELPERS =====================
    const $ = (sel) => document.querySelector(sel);
    const SAFE_CSV_SPLIT = /,(?=(?:[^"]*"[^"]*")*[^"]*$)/;
    const nf = new Intl.NumberFormat('ko-KR');
    const nfc = new Intl.NumberFormat('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const won = (n) => `â‚©${nf.format(Math.round(n||0))}`;
    const toMM = (n) => `â‚©${nfc.format((n||0)/1_000_000)} MM`;

    function showBanner(msg, tone='info') {
      const el = $('#status-banner');
      el.textContent = msg;
      el.classList.remove('hidden');
      el.classList.toggle('border-amber-200', tone==='info');
      el.classList.toggle('bg-amber-50', tone==='info');
      el.classList.toggle('text-amber-800', tone==='info');
      el.classList.toggle('border-red-200', tone==='error');
      el.classList.toggle('bg-red-50', tone==='error');
      el.classList.toggle('text-red-700', tone==='error');
      if (tone!=='info') setTimeout(()=> el.classList.add('hidden'), 3500);
    }
    function hideBanner(){ $('#status-banner').classList.add('hidden'); }

    function setLastUpdated(){ $('#last-updated').textContent = `ìµœê·¼ ì—…ë°ì´íŠ¸: ${new Date().toLocaleString('ko-KR')}`; }

    // ===================== FETCH & PARSE =====================
    async function fetchSheet() {
      showBanner('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦', 'info');
      try {
        const res = await fetch(CSV_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        const text = await res.text();
        const rows = text.trim().split(/\r?\n/);
        if (rows.length <= 1) throw new Error('ì‹œíŠ¸ì— ë°ì´í„°ê°€ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');

        const header = rows[0].split(SAFE_CSV_SPLIT).map(s => s.replaceAll('"','').trim());
        const idx = {
          price: header.findIndex(h => /base|ê¸°ì¤€ê°€|price/i.test(h)),
          code:  header.findIndex(h => /fund.?code|ì½”ë“œ|code/i.test(h)),
          date:  header.findIndex(h => /date|ë‚ ì§œ|ê¸°ì¤€ì¼/i.test(h))
        };
        if (idx.price < 0) idx.price = 4; // í´ë°±
        if (idx.code  < 0) idx.code  = 0; // í´ë°±

        // ìµœì‹ ê°€ ê²°ì • & (ê°€ëŠ¥í•˜ë©´) ë‚ ì§œë³„ ê°€ê²© ë§µ êµ¬ì„±
        const recentRows = rows.slice(1).slice(-200); // ìµœê·¼ Ní–‰ë§Œ í™•ì¸
        const latestByCode = new Map();
        const timeline = new Map(); // date -> Map(code -> price)

        for (const r of recentRows) {
          const cols = r.split(SAFE_CSV_SPLIT).map(s => s.replaceAll('"','').trim());
          const code = cols[idx.code];
          const rawP = cols[idx.price];
          const price = Number(String(rawP||'').replace(/[^0-9.\-]/g,''));
          if (!code || !isFinite(price)) continue;

          // ìµœì‹ ê°€ (ë’¤ì—ì„œë¶€í„° ì˜¤ë¯€ë¡œ ë®ì–´ì“°ì§€ ì•Šê²Œ ì¡´ì¬í•˜ì§€ ì•Šì„ ë•Œë§Œ)
          if (!latestByCode.has(code)) latestByCode.set(code, price);

          if (idx.date >= 0) {
            const d = cols[idx.date];
            const dateKey = normalizeDate(d);
            if (dateKey) {
              if (!timeline.has(dateKey)) timeline.set(dateKey, new Map());
              timeline.get(dateKey).set(code, price);
            }
          }
        }

        // íˆ¬ì ë°°ì—´ ì—…ë°ì´íŠ¸
        for (const inv of investments) {
          const p = latestByCode.get(inv.fund_cd);
          if (isFinite(p)) inv.currentPrice = p; // ì—†ìœ¼ë©´ 0 ìœ ì§€
        }

        renderAll(timeline);
        setLastUpdated();
        hideBanner();
      } catch (e) {
        console.error(e);
        showBanner(`ì˜¤ë¥˜: ${e.message} â€” CSV ê³µê°œ/í—¤ë”ë¥¼ í™•ì¸í•˜ì„¸ìš”.`, 'error');
      }
    }

    function normalizeDate(v){
      if (!v) return null;
      // í—ˆìš©: 2025-09-01, 2025/09/01, 2025.09.01, 09/01/2025, 2025-9-1, etc.
      const t = v.replace(/[.]/g,'/').replace(/-/g,'/').trim();
      const parts = t.split('/').map(x=>x.trim());
      let y,m,d;
      if (parts.length===3){
        if (parts[0].length===4){ y=+parts[0]; m=+parts[1]; d=+parts[2]; }
        else if (parts[2].length===4){ y=+parts[2]; m=+parts[0]; d=+parts[1]; }
      }
      if (!y||!m||!d) { const dt = new Date(v); if (!isNaN(dt)) { y=dt.getFullYear(); m=dt.getMonth()+1; d=dt.getDate(); } }
      if (!y||!m||!d) return null;
      return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    }

    // ===================== RENDER =====================
    let donutChart, barsChart, lineChart;

    function renderAll(timeline){
      renderKPIs();
      renderHoldings();
      renderDonut();
      renderBars();
      renderLine(timeline);
    }

    function calcTotals(){
      let totalVal = cash;
      let totalCost = cash; // í˜„ê¸ˆì€ ì›ê°€=ê°€ì¹˜ ë™ì¼
      for (const inv of investments){
        const qty = inv.quantity / 1000; // ê¸°ì¡´ ë³´ì •ê³¼ ë™ì¼
        totalVal += (inv.currentPrice||0) * qty;
        totalCost += inv.purchasePrice * qty;
      }
      return { totalVal, totalCost, totalPL: totalVal - totalCost };
    }

    function renderKPIs(){
      const { totalVal, totalCost, totalPL } = calcTotals();
      $('#kpi-total').textContent = won(totalVal);
      $('#kpi-total-mm').textContent = toMM(totalVal);
      $('#kpi-cash').textContent = won(cash);
      $('#kpi-count').textContent = String(investments.length + 1);

      const rate = totalCost>0 ? (totalPL/totalCost)*100 : 0;
      const plEl = $('#kpi-pl');
      plEl.textContent = `${totalPL>=0? '+':''}${won(Math.abs(totalPL))}`;
      const rateEl = $('#kpi-pl-rate');
      rateEl.textContent = `ìˆ˜ìµë¥  ${rate>=0?'+':''}${nfc.format(rate)}%`;
      plEl.classList.toggle('text-emerald-600', totalPL>=0);
      plEl.classList.toggle('text-rose-600', totalPL<0);
    }

    function renderHoldings(){
      const wrap = $('#holdings');
      wrap.innerHTML = '';
      for (const inv of investments){
        const qty = inv.quantity/1000;
        const curVal = qty * (inv.currentPrice||0);
        const cost   = qty * inv.purchasePrice;
        const pl     = curVal - cost;
        const gain   = pl >= 0;
        const card = document.createElement('div');
        card.className = 'bg-white dark:bg-slate-800 rounded-2xl p-5 border border-slate-100 dark:border-slate-800 shadow-soft hover:shadow transition-all cursor-pointer';
        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 class="text-lg font-bold">${inv.name}</h3>
              <div class="text-xs text-slate-500">ì½”ë“œ: ${inv.fund_cd}</div>
            </div>
            <div class="text-right">
              <div class="text-sm text-slate-500">í˜„ì¬ í‰ê°€ì•¡</div>
              <div class="text-xl font-extrabold">${toMM(curVal)}</div>
            </div>
          </div>
          <div class="card-details mt-4 text-sm">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <div class="text-slate-500">ìˆ˜ëŸ‰</div>
                <div class="font-semibold">${nf.format(qty)}</div>
              </div>
              <div>
                <div class="text-slate-500">í‰ë‹¨ê°€</div>
                <div class="font-semibold">${won(inv.purchasePrice)}</div>
              </div>
              <div>
                <div class="text-slate-500">í˜„ì¬ ê¸°ì¤€ê°€</div>
                <div class="font-semibold">${inv.currentPrice? won(inv.currentPrice) : 'â€”'}</div>
              </div>
              <div>
                <div class="text-slate-500">í˜„ì¬ ì†ìµ</div>
                <div class="font-semibold ${gain? 'text-emerald-600':'text-rose-600'}">${gain?'+':''}${toMM(Math.abs(pl))}</div>
              </div>
            </div>
          </div>
        `;
        card.addEventListener('click', () => card.querySelector('.card-details').classList.toggle('visible'));
        wrap.appendChild(card);
      }
    }

    function renderDonut(){
      const labels = [...investments.map(i=>i.name), 'í˜„ê¸ˆ'];
      const data = [
        ...investments.map(i => (i.quantity/1000) * (i.currentPrice||0)),
        cash
      ];
      if (donutChart) donutChart.destroy();
      donutChart = new Chart($('#donut').getContext('2d'), {
        type: 'doughnut',
        data: { labels, datasets: [{ data }] },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: ctx => `${ctx.label}: ${toMM(ctx.parsed)}` } } }
        }
      });
    }

    function renderBars(){
      const labels = investments.map(i=>i.name);
      const values = investments.map(i => (i.quantity/1000) * ((i.currentPrice||0) - i.purchasePrice));
      if (barsChart) barsChart.destroy();
      barsChart = new Chart($('#bars').getContext('2d'), {
        type: 'bar',
        data: { labels, datasets: [{ label: 'ì†ìµ (MM)', data: values }] },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: { y: { beginAtZero: true, ticks: { callback: v => toMM(v) } } },
          plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => ` ${toMM(c.parsed.y)}` } } }
        }
      });
    }

    function renderLine(timeline){
      const badge = $('#timeline-badge');
      if (!timeline || timeline.size===0){
        badge.textContent = 'ë‚ ì§œ ì—´ì„ ì°¾ì§€ ëª»í•¨';
        if (lineChart) { lineChart.destroy(); lineChart = null; }
        // ë Œë”ë§ ëŒ€ì‹  ìŠ¤ì¼ˆë ˆí†¤ í‘œì‹œ
        const ctx = $('#line').getContext('2d');
        ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height);
        return;
      }
      badge.textContent = 'ë‚ ì§œ ë°ì´í„° ê°ì§€ë¨';

      // date asc
      const dates = [...timeline.keys()].sort();
      const totals = dates.map(d => {
        let v = cash; // í˜„ê¸ˆ í¬í•¨(ê³ ì •)
        const priceByCode = timeline.get(d);
        for (const inv of investments){
          const p = priceByCode.get(inv.fund_cd);
          if (isFinite(p)) v += (inv.quantity/1000) * p;
        }
        return v;
      });

      if (lineChart) lineChart.destroy();
      lineChart = new Chart($('#line').getContext('2d'), {
        type: 'line',
        data: { labels: dates, datasets: [{ label: 'ì´ í‰ê°€ì•¡', data: totals, tension: 0.25, fill: false }] },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: { y: { ticks: { callback: v => toMM(v) } } },
          plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => ` ${toMM(c.parsed.y)}` } } }
        }
      });
    }

    // ===================== INTERACTION =====================
    function enterFullscreen(){
      const el = document.documentElement;
      if (el.requestFullscreen) el.requestFullscreen();
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      else if (el.msRequestFullscreen) el.msRequestFullscreen();
    }

    function applyStoredTheme(){
      const stored = localStorage.getItem('theme-mode');
      if (stored === 'dark') document.documentElement.classList.add('dark');
    }

    function toggleTheme(){
      const html = document.documentElement;
      html.classList.toggle('dark');
      localStorage.setItem('theme-mode', html.classList.contains('dark') ? 'dark' : 'light');
    }

    // ===================== INIT =====================
    window.addEventListener('load', () => {
      applyStoredTheme();
      $('#refreshBtn').addEventListener('click', fetchSheet);
      $('#toggleTheme').addEventListener('click', toggleTheme);
      $('#fullscreen-button').addEventListener('click', enterFullscreen);
      fetchSheet();
      setInterval(fetchSheet, REFRESH_MS);
    });
  </script>
</body>
</html>
